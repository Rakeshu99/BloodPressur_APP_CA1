name: CD Pipeline

# --------------------------------------------------------
# CD runs ONLY after CI pipeline succeeds
# --------------------------------------------------------
on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]

env:
  DEV_URL: "https://bp-app-rakesh-dev.francecentral-01.azurewebsites.net"
  QA_URL: "https://bp-app-rakesh-qa.francecentral-01.azurewebsites.net"
  PROD_URL: "https://bp-app-rakesh.francecentral-01.azurewebsites.net"

jobs:

  # ============================================================
  # 1) DEPLOY TO DEV SLOT
  # ============================================================
  deploy_dev:
    name: Deploy to DEV slot
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'success'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # Download build artifact generated by CI
    - name: Download CI build output
      uses: actions/download-artifact@v4
      with:
        name: build-output
        path: publish
        run-id: ${{ github.event.workflow_run.id }}

    - name: Deploy to DEV slot
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
        slot-name: "dev"
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUB_DEV }}
        package: publish

  # ============================================================
  # 2) RUN E2E SELENIUM TESTS ON DEV
  # ============================================================
  e2e_tests_dev:
    name: E2E Tests on DEV (Chrome + Edge)
    runs-on: ubuntu-latest
    needs: deploy_dev

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: "9.0.x"

    - name: Install Chrome
      uses: browser-actions/setup-chrome@latest

    - name: Install Edge
      uses: browser-actions/setup-edge@v1

    # Run Selenium tests in Chrome
    - name: Run Selenium E2E (Chrome)
      env:
        BASE_URL: ${{ env.DEV_URL }}
        BROWSER: chrome
      run: |
        cd BPCalculator.E2E
        dotnet test --logger "trx;LogFileName=e2e-chrome.trx" --results-directory ../TestResults

    # Run Selenium tests in Edge
    - name: Run Selenium E2E (Edge)
      env:
        BASE_URL: ${{ env.DEV_URL }}
        BROWSER: edge
      run: |
        cd BPCalculator.E2E
        dotnet test --logger "trx;LogFileName=e2e-edge.trx" --results-directory ../TestResults

    - name: Upload E2E Test Reports
      uses: actions/upload-artifact@v4
      with:
        name: e2e-test-results
        path: TestResults/

  # ============================================================
  # 3) DEPLOY TO QA SLOT (Only if Dev E2E PASSED)
  # ============================================================
  deploy_qa:
    name: Deploy to QA slot
    runs-on: ubuntu-latest
    needs: e2e_tests_dev

    steps:
    - uses: actions/checkout@v4

    - name: Download CI build output
      uses: actions/download-artifact@v4
      with:
        name: build-output
        path: publish
        run-id: ${{ github.event.workflow_run.id }}

    - name: Deploy to QA slot
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
        slot-name: "qa"
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUB_QA }}
        package: publish

  # ============================================================
  # 4) PERFORMANCE TESTING ON QA (k6)
  # ============================================================
  performance_test:
    name: Performance Tests (k6) on QA
    runs-on: ubuntu-latest
    needs: deploy_qa

    steps:
    - name: Prepare k6 directory
      run: mkdir -p perf-results

    - name: Run k6 smoke test
      uses: grafana/k6-action@v0.2.0
      env:
        APP_URL: ${{ env.QA_URL }}
        K6_SUMMARY_EXPORT: perf-results/smoke.json
      with:
        filename: perf/k6-smoke.js

    - name: Run k6 load test
      uses: grafana/k6-action@v0.2.0
      env:
        APP_URL: ${{ env.QA_URL }}
        K6_SUMMARY_EXPORT: perf-results/load.json
      with:
        filename: perf/k6-load.js

    - name: Run k6 stress test
      uses: grafana/k6-action@v0.2.0
      env:
        APP_URL: ${{ env.QA_URL }}
        K6_SUMMARY_EXPORT: perf-results/stress.json
      with:
        filename: perf/k6-stress.js

    - name: Upload performance reports
      uses: actions/upload-artifact@v4
      with:
        name: performance-test-results
        path: perf-results/

  # ============================================================
  # 5) SECURITY TESTING ON QA (OWASP ZAP BASELINE)
  # ============================================================
  security_scan:
    name: Security Scan (ZAP)
    runs-on: ubuntu-latest
    needs: performance_test

    steps:
    - name: Run ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.11.0
      with:
        target: ${{ env.QA_URL }}
        cmd_options: "-a"
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload ZAP Report
      uses: actions/upload-artifact@v4
      with:
        name: zap-report
        path: zap_report.html

  # ============================================================
  # 6) MANUAL APPROVAL BEFORE PROD DEPLOYMENT
  # ============================================================
  approval_gate:
    name: Manual Approval Required
    needs: security_scan
    runs-on: ubuntu-latest

    steps:
    - name: Wait for Approval
      uses: trstringer/manual-approval@v1
      with:
        approvers: "Rakeshu99"
        minimum-approvals: 1

  # ============================================================
  # 7) DEPLOY TO PRODUCTION
  # ============================================================
  deploy_prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: approval_gate

    steps:
    - uses: actions/checkout@v4

    - name: Download CI build output
      uses: actions/download-artifact@v4
      with:
        name: build-output
        path: publish
        run-id: ${{ github.event.workflow_run.id }}

    - name: Deploy to Production
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUB_PROD }}
        package: publish

  # ============================================================
  # 8) SMOKE TEST ON PRODUCTION
  # ============================================================
  prod_smoke_test:
    name: Smoke Test Production
    needs: deploy_prod
    runs-on: ubuntu-latest

    steps:
    - name: Check Homepage Status
      run: |
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.PROD_URL }})
        if [ "$STATUS" != "200" ]; then exit 1; fi
