name: CD Pipeline

on:
  push:
    branches:
      - dev          # When code merges into dev → start CD
  workflow_dispatch:

jobs:

  # ============================================================
  # 1) DEPLOY TO DEV SLOT
  # ============================================================
  deploy_dev:
    name: Deploy to DEV Slot
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Setup .NET 9
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: "9.0.x"

    - name: Publish project
      run: dotnet publish BPCalculator/BPCalculator.csproj -c Release -o publish

    - name: Deploy to Azure (DEV slot)
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
        slot-name: "dev"
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUB_DEV }}
        package: ./publish

  # ============================================================
  # 2) E2E SELENIUM TESTS ON DEV
  # ============================================================
  e2e_tests_dev:
    name: Run E2E Tests on DEV
    needs: deploy_dev
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Chrome
      uses: browser-actions/setup-chrome@latest

    - name: Install .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: "9.0.x"

    - name: Run Selenium E2E tests
      env:
        BASE_URL: "https://bp-app-rakesh-dev.francecentral-01.azurewebsites.net"
      run: |
        cd BPCalculator.E2E
        dotnet test --logger "trx"

  # ============================================================
  # 3) DEPLOY TO QA SLOT
  # ============================================================
  deploy_qa:
    name: Deploy to QA Slot
    runs-on: ubuntu-latest
    needs: e2e_tests_dev   # Only deploy if E2E passed

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: "9.0.x"

    - name: Publish project
      run: dotnet publish BPCalculator/BPCalculator.csproj -c Release -o publish

    - name: Deploy to Azure (QA slot)
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
        slot-name: "qa"
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUB_QA }}
        package: ./publish

  # ============================================================
  # 4) PERFORMANCE TESTING ON QA
  # ============================================================
  performance_test:
    name: Performance Load Test on QA
    needs: deploy_qa
    runs-on: ubuntu-latest

    steps:
    - name: Run simple load test
      run: |
        echo "Running performance test..."
        siege -t10S -c10 https://bp-app-rakesh-qa.francecentral-01.azurewebsites.net

  # ============================================================
  # 5) MANUAL APPROVAL FOR PROD
  # ============================================================
  approval_gate:
    name: Manual Approval Required
    needs: performance_test
    runs-on: ubuntu-latest

    steps:
    - name: Wait for approval
      uses: trstringer/manual-approval@v1
      with:
        approvers: your-github-username
        minimum-approvals: 1

  # ============================================================
  # 6) DEPLOY TO PROD
  # ============================================================
  deploy_prod:
    name: Deploy to Production
    needs: approval_gate
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: "9.0.x"

    - name: Publish project
      run: dotnet publish BPCalculator/BPCalculator.csproj -c Release -o publish

    - name: Deploy to Azure Production
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUB_PROD }}
        package: ./publish

  # ============================================================
  # 7) SMOKE TEST ON PROD
  # ============================================================
  prod_smoke_test:
    name: Smoke Test Production
    needs: deploy_prod
    runs-on: ubuntu-latest

    steps:
    - name: Validate Homepage
      run: |
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://bp-app-rakesh.francecentral-01.azurewebsites.net)
        if [ "$STATUS" != "200" ]; then exit 1; fi
